<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sdesaireader ‚Äî Production-Ready</title>
  <style>
    body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif; background:#f5f7fa; margin:0; padding:20px; color:#333; }
    .container { max-width:600px; margin:0 auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,.08); }
    h2 { margin-top:0; color:#2c3e50; }
    .upload-area { border:2px dashed #3498db; padding:35px 20px; margin:20px 0; cursor:pointer; border-radius:10px; transition:.3s; }
    .upload-area:hover { background:#e3f2fd; }
    button { background:#2980b9; color:#fff; border:none; padding:12px 24px; margin:6px 4px; border-radius:6px; font-weight:600; cursor:pointer; font-size:1rem; }
    button:disabled { background:#bdc3c7; opacity:0.7; cursor:not-allowed; }
    #output { text-align:left; background:#fafafa; padding:14px; border-radius:8px; height:150px; overflow-y:auto; margin-top:20px; white-space:pre-wrap; border:1px solid #eee; font-size:0.95rem; line-height:1.5; }
    .status { font-weight:600; margin:12px 0; padding:8px 12px; border-radius:6px; display:inline-block; min-width:200px; }
    .status.ok { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .status.warn { background:#fff3cd; color:#856404; border:1px solid #ffeaa7; }
    .status.err { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .lang-indicator { font-size:0.95rem; margin-top:8px; color:#27ae60; font-weight:bold; }
    .voice-info { font-size:0.85rem; color:#7f8c8d; margin-top:5px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üéß Sdesaireader ‚Äî Guaranteed Audio</h2>
    <p><small>No setup. No installs. Works on any phone.</small></p>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
      <p id="uploadText">üìÅ Tap to Upload PDF or Image</p>
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" />
    </div>

    <div class="status" id="status">Status: Ready</div>
    <div class="lang-indicator" id="langIndicator">Language: Not detected</div>
    <div class="voice-info" id="voiceInfo">Voice: Checking...</div>

    <button id="processBtn" disabled>üîç Extract Text</button>
    <hr>
    <button id="readBtn" disabled>üó£Ô∏è Play Audio</button>
    <button id="stopBtn">‚èπÔ∏è Stop</button>

    <div id="output">Extracted text appears here‚Ä¶</div>
  </div>

  <!-- Tesseract.js -->
  <script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const readBtn = document.getElementById('readBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');
    const langIndicator = document.getElementById('langIndicator');
    const voiceInfo = document.getElementById('voiceInfo');
    const output = document.getElementById('output');

    let extractedText = "";
    let detectedLang = "en";
    let voices = [];
    let isSpeaking = false;

    // üß† Language Detection (improved)
    function detectLanguage(text) {
      if (!text || text.trim().length < 3) return "en";

      const gujCount = (text.match(/[\u0A80-\u0AFF]/g) || []).length;
      const devaCount = (text.match(/[\u0900-\u097F]/g) || []).length;
      const engCount = (text.match(/[a-zA-Z]/g) || []).length;

      if (gujCount > 5) return "gu";
      if (devaCount > 5) return "hi";
      if (engCount > 15) return "en";
      return "en"; // safe default
    }

    // üéôÔ∏è Load & cache voices
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      const guj = voices.filter(v => v.lang.toLowerCase().includes('gu'));
      const hi = voices.filter(v => v.lang.toLowerCase().includes('hi') || v.lang.toLowerCase().includes('devanagari'));
      const en = voices.filter(v => v.lang.toLowerCase().startsWith('en'));

      if (guj.length > 0) {
        detectedLang = "gu";
        voiceInfo.textContent = `‚úÖ Gujarati voice found: "${guj[0].name}"`;
      } else if (hi.length > 0) {
        detectedLang = "hi";
        voiceInfo.textContent = `‚úÖ Hindi voice found: "${hi[0].name}"`;
      } else if (en.length > 0) {
        detectedLang = "en";
        voiceInfo.textContent = `‚úÖ English voice found: "${en[0].name}"`;
      } else {
        voiceInfo.textContent = "‚ö†Ô∏è No voices detected. Try restarting browser.";
      }
    }

    // ‚è±Ô∏è Wait for voices with timeout
    async function waitForVoices(maxWaitMs = 5000) {
      return new Promise((resolve) => {
        const start = Date.now();
        const check = () => {
          if (voices.length > 0) return resolve(true);
          if (Date.now() - start > maxWaitMs) return resolve(false);
          setTimeout(check, 200);
        };
        check();
      });
    }

    // üì• File selection
    fileInput.onchange = () => {
      if (fileInput.files[0]) {
        status.className = "status warn";
        status.textContent = "Status: File selected";
        processBtn.disabled = false;
        document.getElementById('uploadText').textContent = fileInput.files[0].name;
      }
    };

    // üßæ OCR
    processBtn.onclick = async () => {
      status.className = "status warn";
      status.textContent = "Status: Extracting text...";
      processBtn.disabled = true;
      readBtn.disabled = true;

      try {
        const file = fileInput.files[0];
        const worker = await Tesseract.createWorker();
        await worker.load();
        await worker.loadLanguage('guj+eng+hin');
        await worker.initialize('guj+eng+hin');
        const { data: { text } } = await worker.recognize(file);
        await worker.terminate();

        extractedText = text.trim();
        output.textContent = extractedText;

        if (!extractedText) {
          status.className = "status err";
          status.textContent = "Status: No text found. Try clearer image.";
          readBtn.disabled = true;
          langIndicator.textContent = "Language: None";
        } else {
          const lang = detectLanguage(extractedText);
          detectedLang = lang;
          const names = { gu: "Gujarati", hi: "Hindi", en: "English" };
          langIndicator.textContent = `Language: ${names[lang]} ‚úÖ`;

          status.className = "status ok";
          status.textContent = `Status: Extracted (${extractedText.length} chars)`;
          readBtn.disabled = false;
        }
      } catch (error) {
        status.className = "status err";
        status.textContent = `‚ùå OCR Error: ${error.message || 'Unknown'}`;
        console.error(error);
        processBtn.disabled = false;
      }
    };

    // ‚ñ∂Ô∏è Speak with full reliability
    readBtn.onclick = async () => {
      if (!extractedText) {
        status.className = "status err";
        status.textContent = "‚ùå No text to speak. Extract first.";
        return;
      }

      status.className = "status warn";
      status.textContent = "Status: Preparing audio...";

      // Ensure voices are loaded
      const voicesLoaded = await waitForVoices(4000);
      if (!voicesLoaded) {
        status.className = "status err";
        status.textContent = "‚ùå Voices not ready. Try again in a few seconds.";
        return;
      }

      // Pick best voice
      const langMap = {
        gu: v => v.lang.toLowerCase().includes('gu'),
        hi: v => v.lang.toLowerCase().includes('hi') || v.lang.toLowerCase().includes('devanagari'),
        en: v => v.lang.toLowerCase().startsWith('en')
      };

      const bestVoice = voices.find(langMap[detectedLang]) || voices[0];

      if (!bestVoice) {
        status.className = "status err";
        status.textContent = "‚ùå No matching voice found.";
        return;
      }

      // Sanitize text
      const cleanText = extractedText.replace(/\s+/g, ' ').trim().substring(0, 500);
      if (!cleanText) {
        status.className = "status err";
        status.textContent = "‚ùå Nothing to say (empty text).";
        return;
      }

      // Speak!
      const utter = new SpeechSynthesisUtterance(cleanText);
      utter.voice = bestVoice;
      utter.rate = 0.9;
      utter.pitch = 1.0;

      utter.onstart = () => {
        isSpeaking = true;
        status.className = "status ok";
        status.textContent = `üîä Speaking in ${detectedLang.toUpperCase()}...`;
      };

      utter.onend = () => {
        isSpeaking = false;
        status.className = "status ok";
        status.textContent = "‚úÖ Done.";
      };

      utter.onerror = (event) => {
        isSpeaking = false;
        status.className = "status err";
        status.textContent = `‚ùå Speech error: ${event.error || 'Unknown'}`;
        console.error("Speech error:", event);
      };

      speechSynthesis.cancel(); // stop any previous
      speechSynthesis.speak(utter);
    };

    // ‚èπÔ∏è Stop
    stopBtn.onclick = () => {
      speechSynthesis.cancel();
      isSpeaking = false;
      status.className = "status ok";
      status.textContent = "‚èπÔ∏è Stopped.";
    };

    // üöÄ Initialize
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices(); // run once immediately

    // üñ±Ô∏è Drag & Drop
    const uploadArea = document.querySelector('.upload-area');
    ['dragover', 'dragleave', 'drop'].forEach(evt =>
      uploadArea.addEventListener(evt, e => {
        e.preventDefault();
        if (evt === 'dragover') uploadArea.style.backgroundColor = '#e3f2fd';
        if (evt === 'dragleave' || evt === 'drop') uploadArea.style.backgroundColor = '';
      })
    );

    uploadArea.addEventListener('drop', e => {
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        fileInput.onchange();
      }
    });
  </script>
</body>
</html>

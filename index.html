<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sdesaireader - Final Fix</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f4f6f9; margin:0; padding:20px; text-align:center; }
    .container { max-width:600px; margin:0 auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .upload-area { border:3px dashed #3498db; padding:40px; margin:20px 0; cursor:pointer; border-radius:10px; }
    button { background:#3498db; color:#fff; border:none; padding:12px 20px; margin:5px; border-radius:6px; font-weight:bold; cursor:pointer; }
    button:disabled { background:#ccc; }
    #output { text-align:left; background:#f9f9f9; padding:15px; border-radius:8px; height:150px; overflow-y:auto; margin-top:20px; white-space:pre-wrap; border:1px solid #ddd; }
    select, input { margin:10px; padding:8px; border-radius:5px; border:1px solid #ddd; }
    .status { color: #555; font-size: 0.9rem; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚ú® Sdesaireader Upgraded</h2>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
      <p id="uploadText">Tap to Upload Scanned PDF or Image</p>
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" />
    </div>

    <div class="status" id="status">Status: Ready</div>
    
    <button id="processBtn" disabled>üîç 1. Extract Text</button>
    <hr>
    
    <div>
      <label>Voice:</label><br>
      <select id="voiceSelect"><option>Loading voices...</option></select>
    </div>

    <div>
      <label>Speed:</label>
      <input type="range" id="speedSlider" min="0.5" max="1.5" step="0.1" value="1">
    </div>

    <button id="readBtn" disabled>üó£Ô∏è 2. Read Aloud</button>
    <button id="stopBtn">‚èπÔ∏è Stop</button>

    <div id="output">Extracted text will appear here...</div>
  </div>

  <script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const readBtn = document.getElementById('readBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    const voiceSelect = document.getElementById('voiceSelect');
    const speedSlider = document.getElementById('speedSlider');

    let extractedText = "";

    // 1. Load Voices properly for Mobile
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = '';
      voices.forEach((voice, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${voice.name} (${voice.lang})`;
        if (voice.lang.includes('gu')) option.selected = true; // Auto-select Gujarati
        voiceSelect.appendChild(option);
      });
      if (voices.length === 0) {
        voiceSelect.innerHTML = '<option>No voices found. Check device settings.</option>';
      }
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    // 2. Handle File Selection
    fileInput.onchange = () => {
      if(fileInput.files[0]) {
        status.textContent = "Status: File selected. Click Extract.";
        processBtn.disabled = false;
        document.getElementById('uploadText').textContent = fileInput.files[0].name;
      }
    };

    // 3. OCR Extraction
    processBtn.onclick = async () => {
      status.textContent = "Status: Extracting text (Please wait...)";
      processBtn.disabled = true;
      const file = fileInput.files[0];
      const worker = await Tesseract.createWorker();
      await worker.load();
      await worker.loadLanguage('guj+eng');
      await worker.initialize('guj+eng');
      const { data: { text } } = await worker.recognize(file);
      await worker.terminate();
      
      extractedText = text;
      output.textContent = text;
      status.textContent = "Status: Extraction Complete!";
      readBtn.disabled = false;
    };

    // 4. Speech Function (The Fix)
    readBtn.onclick = () => {
      // Cancel any existing speech first
      speechSynthesis.cancel();

      const utter = new SpeechSynthesisUtterance(extractedText);
      const voices = speechSynthesis.getVoices();
      
      // Use selected voice from dropdown
      if (voices[voiceSelect.value]) {
        utter.voice = voices[voiceSelect.value];
      }
      
      utter.rate = speedSlider.value;
      
      utter.onstart = () => status.textContent = "Status: Speaking...";
      utter.onend = () => status.textContent = "Status: Finished.";
      utter.onerror = (e) => status.textContent = "Status: Speech Error: " + e.error;

      // On some mobile browsers, we need to resume audio context
      speechSynthesis.speak(utter);
      
      // Fix for Chrome/Safari getting stuck
      const amIStillSpeaking = setInterval(() => {
        if (!speechSynthesis.speaking) {
          clearInterval(amIStillSpeaking);
        } else {
          speechSynthesis.resume();
        }
      }, 5000);
    };

    stopBtn.onclick = () => {
      speechSynthesis.cancel();
      status.textContent = "Status: Stopped.";
    };
  </script>
</body>
</html>

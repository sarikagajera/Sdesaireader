<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sdesaireader ‚Äî Universal Document Reader</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1a1a2e;
      --paper: #f5f0e8;
      --accent: #c0392b;
      --accent2: #e67e22;
      --muted: #8c8070;
      --card: #fffdf8;
      --border: #ddd5c5;
      --green: #27ae60;
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--paper);
      min-height: 100vh;
      color: var(--ink);
      background-image: 
        radial-gradient(ellipse at 10% 10%, rgba(192,57,43,0.06) 0%, transparent 60%),
        radial-gradient(ellipse at 90% 90%, rgba(230,126,34,0.06) 0%, transparent 60%);
    }

    .wrapper {
      max-width: 680px;
      margin: 0 auto;
      padding: 40px 20px 60px;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      text-align: center;
      margin-bottom: 40px;
    }
    header h1 {
      font-family: 'DM Serif Display', serif;
      font-size: clamp(2rem, 6vw, 3.2rem);
      color: var(--ink);
      letter-spacing: -0.02em;
      line-height: 1.1;
    }
    header h1 em {
      color: var(--accent);
      font-style: italic;
    }
    header p {
      margin-top: 8px;
      color: var(--muted);
      font-size: 0.95rem;
      font-weight: 300;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-body { padding: 20px; }

    /* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 48px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(192,57,43,0.03);
    }
    .drop-zone input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }
    .drop-icon { font-size: 2.5rem; margin-bottom: 12px; display: block; }
    .drop-label { font-size: 1rem; font-weight: 500; color: var(--ink); }
    .drop-sub { font-size: 0.82rem; color: var(--muted); margin-top: 4px; }
    .file-pill {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--ink); color: white; border-radius: 999px;
      padding: 6px 16px; font-size: 0.85rem; margin-top: 12px;
    }

    /* ‚îÄ‚îÄ LANGUAGE SELECT ‚îÄ‚îÄ */
    .lang-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .lang-row {
      display: flex; gap: 10px; align-items: center;
    }
    label.field-label {
      font-size: 0.8rem; font-weight: 600; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.08em;
      display: block; margin-bottom: 6px;
    }
    select, .select-wrap select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      color: var(--ink);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238c8070' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    select:focus { outline: 2px solid var(--accent); border-color: transparent; }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 14px 24px; border: none; border-radius: 8px;
      font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; width: 100%;
    }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-primary { background: var(--ink); color: white; }
    .btn-primary:not(:disabled):hover { background: #2c2c50; transform: translateY(-1px); }
    .btn-green { background: var(--green); color: white; }
    .btn-green:not(:disabled):hover { background: #219a52; transform: translateY(-1px); }
    .btn-red { background: var(--accent); color: white; }
    .btn-red:not(:disabled):hover { background: #a93226; transform: translateY(-1px); }
    .btn-outline { background: transparent; color: var(--ink); border: 1.5px solid var(--border); }
    .btn-outline:not(:disabled):hover { border-color: var(--ink); }

    .btn-row { display: flex; gap: 10px; }
    .btn-row .btn { flex: 1; }

    /* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
    .status-bar {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.88rem;
      font-weight: 500;
      display: flex; align-items: center; gap: 8px;
      transition: all 0.3s;
      background: #e8f4fd;
      color: #1a5276;
    }
    .status-bar.success { background: #eafaf1; color: #1e8449; }
    .status-bar.error { background: #fdf2f2; color: #922b21; }
    .status-bar.warning { background: #fefce8; color: #7d6608; }

    /* ‚îÄ‚îÄ OUTPUT ‚îÄ‚îÄ */
    #output {
      min-height: 160px;
      max-height: 380px;
      overflow-y: auto;
      font-size: 1rem;
      line-height: 1.75;
      color: var(--ink);
      white-space: pre-wrap;
      word-break: break-word;
    }
    #output.placeholder { color: var(--muted); font-style: italic; }

    /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
    .progress-bar {
      height: 4px; background: var(--border); border-radius: 99px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 99px; width: 0%; transition: width 0.3s;
    }
    .progress-label { font-size: 0.78rem; color: var(--muted); margin-top: 5px; }

    /* ‚îÄ‚îÄ VOICE CONTROLS ‚îÄ‚îÄ */
    .slider-row { display: flex; align-items: center; gap: 12px; }
    .slider-row label { font-size: 0.82rem; color: var(--muted); white-space: nowrap; min-width: 50px; }
    input[type=range] {
      flex: 1; accent-color: var(--accent); cursor: pointer;
    }
    .slider-val { font-size: 0.82rem; font-weight: 600; min-width: 30px; text-align: right; }

    /* ‚îÄ‚îÄ PULSE ‚îÄ‚îÄ */
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .reading-pulse { animation: pulse 1.5s infinite; }

    /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
    #output::-webkit-scrollbar { width: 6px; }
    #output::-webkit-scrollbar-track { background: transparent; }
    #output::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>
<div class="wrapper">

  <header>
    <h1>Sdesai<em>reader</em></h1>
    <p>Upload any image or PDF ‚Äî text extracts automatically & reads aloud</p>
  </header>

  <!-- STEP 1: Upload -->
  <div class="card">
    <div class="card-header">‚ë† Upload File ‚Äî extracts automatically</div>
    <div class="card-body">
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.webp,.bmp,.tiff" />
        <span class="drop-icon">üìÑ</span>
        <div class="drop-label">Tap to upload or drag & drop</div>
        <div class="drop-sub">Images (JPG, PNG, WEBP) ¬∑ PDF</div>
        <div id="filePill" style="display:none">
          <span class="file-pill"><span>üìé</span><span id="fileName"></span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Detected language badge -->
  <div id="langBadge" style="display:none; margin-bottom:16px; padding:10px 16px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); font-size:0.88rem; font-weight:500; color:var(--ink); box-shadow:0 2px 8px rgba(0,0,0,0.05);">
    üåê Detected language: <strong id="langName">‚Äî</strong>
  </div>

  <!-- Progress bar (shown during extraction, no button needed) -->
  <div id="progressWrap" style="display:none; margin-bottom:16px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-label" id="progressLabel">Starting‚Ä¶</div>
  </div>
  <button id="extractBtn" style="display:none"></button>

  <!-- STATUS -->
  <div class="status-bar" id="statusBar">
    üìã Upload a file to get started
  </div>
  <div style="height:16px"></div>

  <!-- Hidden output (still used internally) -->
  <div id="output" style="display:none"></div>
  <button id="copyBtn" style="display:none"></button>

  <!-- STEP 4: Read Aloud -->
  <div class="card">
    <div class="card-header">‚ë° Read Aloud</div>
    <div class="card-body" style="display:flex;flex-direction:column;gap:14px">

      <div class="slider-row">
        <label>Speed</label>
        <input type="range" id="rateSlider" min="0.5" max="2" step="0.05" value="0.9">
        <span class="slider-val" id="rateVal">0.9√ó</span>
      </div>
      <div class="slider-row">
        <label>Pitch</label>
        <input type="range" id="pitchSlider" min="0.5" max="2" step="0.05" value="1">
        <span class="slider-val" id="pitchVal">1.0</span>
      </div>

      <div class="btn-row">
        <button class="btn btn-green" id="readBtn" disabled>üîä Read Aloud</button>
        <button class="btn btn-red" id="stopBtn">‚èπ Stop</button>
      </div>
    </div>
  </div>

</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Tesseract -->
<script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>

<script>
  // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
  const fileInput   = document.getElementById('fileInput');
  const dropZone    = document.getElementById('dropZone');
  const extractBtn  = document.getElementById('extractBtn');
  const readBtn     = document.getElementById('readBtn');
  const stopBtn     = document.getElementById('stopBtn');
  const copyBtn     = document.getElementById('copyBtn');
  const statusBar   = document.getElementById('statusBar');
  const output      = document.getElementById('output');
  const rateSlider  = document.getElementById('rateSlider');
  const pitchSlider = document.getElementById('pitchSlider');
  const rateVal     = document.getElementById('rateVal');
  const pitchVal    = document.getElementById('pitchVal');
  const progressWrap= document.getElementById('progressWrap');
  const progressFill= document.getElementById('progressFill');
  const progressLabel=document.getElementById('progressLabel');
  const filePill    = document.getElementById('filePill');
  const fileNameEl  = document.getElementById('fileName');

  // PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const langBadge  = document.getElementById('langBadge');
  const langName   = document.getElementById('langName');

  let extractedText = "";
  let detectedLang  = 'en';   // BCP-47 tag used for voice matching

  // ‚îÄ‚îÄ Sliders ‚îÄ‚îÄ
  rateSlider.oninput  = () => rateVal.textContent  = parseFloat(rateSlider.value).toFixed(2) + '√ó';
  pitchSlider.oninput = () => pitchVal.textContent = parseFloat(pitchSlider.value).toFixed(2);

  // ‚îÄ‚îÄ Voices ‚îÄ‚îÄ
  function loadVoices() {
    const voices = window.speechSynthesis.getVoices();
    if (!voices.length) return;
    window._voices = voices;
  }
  window.speechSynthesis.onvoiceschanged = loadVoices;
  if (window.speechSynthesis.getVoices().length) loadVoices();
  setTimeout(loadVoices, 500);

  // ‚îÄ‚îÄ Detect language from text using Unicode script ranges ‚îÄ‚îÄ
  function detectLanguage(text) {
    const counts = {};
    const scripts = [
      { name: 'Gujarati',   lang: 'gu-IN', tess: 'guj',     re: /[\u0A80-\u0AFF]/g },
      { name: 'Hindi',      lang: 'hi-IN', tess: 'hin',     re: /[\u0900-\u097F]/g },
      { name: 'Arabic',     lang: 'ar-SA', tess: 'ara',     re: /[\u0600-\u06FF]/g },
      { name: 'Russian',    lang: 'ru-RU', tess: 'rus',     re: /[\u0400-\u04FF]/g },
      { name: 'Chinese',    lang: 'zh-CN', tess: 'chi_sim', re: /[\u4E00-\u9FFF]/g },
      { name: 'Japanese',   lang: 'ja-JP', tess: 'jpn',     re: /[\u3040-\u30FF]/g },
      { name: 'Korean',     lang: 'ko-KR', tess: 'kor',     re: /[\uAC00-\uD7AF]/g },
      { name: 'English',    lang: 'en-US', tess: 'eng',     re: /[A-Za-z]/g },
    ];

    let best = scripts[scripts.length - 1]; // default English
    let bestCount = 0;

    for (const s of scripts) {
      const m = text.match(s.re);
      const count = m ? m.length : 0;
      counts[s.name] = count;
      if (count > bestCount) { bestCount = count; best = s; }
    }
    return best;
  }

  // ‚îÄ‚îÄ Pick best voice for detected language ‚îÄ‚îÄ
  function pickVoice(langTag) {
    const voices = window._voices || window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;

    const primary = langTag.toLowerCase();            // e.g. "gu-in"
    const base    = primary.split('-')[0];            // e.g. "gu"

    // Try exact match first, then base language match
    return voices.find(v => v.lang.toLowerCase() === primary)
        || voices.find(v => v.lang.toLowerCase().startsWith(base))
        || voices.find(v => v.lang.toLowerCase().startsWith('en'))  // fallback English
        || voices[0];                                               // last resort
  }

  // ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.classList.remove('drag-over');
    if (e.dataTransfer.files.length) {
      const dt = new DataTransfer();
      dt.items.add(e.dataTransfer.files[0]);
      fileInput.files = dt.files;
      setFile(e.dataTransfer.files[0]);
    }
  });

  fileInput.onchange = () => { if (fileInput.files.length) setFile(fileInput.files[0]); };

  function setFile(f) {
    fileNameEl.textContent = f.name.length > 32 ? f.name.slice(0,30)+'‚Ä¶' : f.name;
    filePill.style.display = 'block';
    extractBtn.disabled = false;
    doExtract(f);
  }

  // ‚îÄ‚îÄ Status ‚îÄ‚îÄ
  function setStatus(msg, type='info') {
    statusBar.className = 'status-bar' + (type==='success'?' success':type==='error'?' error':type==='warning'?' warning':'');
    statusBar.innerHTML = msg;
  }

  // ‚îÄ‚îÄ Progress ‚îÄ‚îÄ
  function showProgress(pct, label) {
    progressWrap.style.display = 'block';
    progressFill.style.width = pct + '%';
    progressLabel.textContent = label;
  }
  function hideProgress() { progressWrap.style.display = 'none'; }

  // ‚îÄ‚îÄ Extract button (hidden but kept for internal use) ‚îÄ‚îÄ
  extractBtn.onclick = async function() {
    const file = fileInput.files[0];
    if (file) doExtract(file);
  };

  // ‚îÄ‚îÄ Core extract logic ‚îÄ‚îÄ
  async function doExtract(file) {
    extractBtn.disabled = true;
    readBtn.disabled = true;
    copyBtn.disabled = true;
    langBadge.style.display = 'none';
    showProgress(5, 'Starting extraction‚Ä¶');
    setStatus('‚è≥ Extracting text‚Ä¶', 'info');
    extractedText = "";

    try {
      const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
      extractedText = isPDF ? await extractPDF(file) : await extractImage(file);
      extractedText = extractedText.trim();

      if (extractedText.length < 5) {
        throw new Error("No readable text found. Try a clearer image.");
      }

      // ‚îÄ‚îÄ Auto-detect language ‚îÄ‚îÄ
      const detected = detectLanguage(extractedText);
      detectedLang = detected.lang;
      langName.textContent = detected.name;
      langBadge.style.display = 'block';

      setStatus(`‚úÖ Ready to read ‚Äî detected ${detected.name}`, 'success');
      readBtn.disabled = false;
      copyBtn.disabled = false;
    } catch(err) {
      setStatus('‚ùå ' + err.message, 'error');
    }

    hideProgress();
    extractBtn.disabled = false;
  }

  // ‚îÄ‚îÄ PDF extraction ‚îÄ‚îÄ
  async function extractPDF(file) {
    showProgress(10, 'Loading PDF‚Ä¶');
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const totalPages = pdf.numPages;
    let fullText = "";

    for (let i = 1; i <= totalPages; i++) {
      showProgress(10 + (i / totalPages) * 85, `Reading page ${i} of ${totalPages}‚Ä¶`);
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      fullText += content.items.map(item => item.str).join(' ') + '\n';
    }

    showProgress(100, 'Done!');

    if (fullText.trim().length < 20) {
      showProgress(50, 'No embedded text ‚Äî running OCR‚Ä¶');
      fullText = await ocrPDFPage(file);
    }
    return fullText;
  }

  async function ocrPDFPage(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width; canvas.height = viewport.height;
    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
    return await runTesseract(blob);
  }

  async function extractImage(file) { return await runTesseract(file); }

  // Always use broad multi-language OCR ‚Äî let auto-detection handle the rest
  async function runTesseract(file) {
    const lang = 'eng+hin+guj';
    showProgress(10, 'Scanning document‚Ä¶');
    const worker = await Tesseract.createWorker(lang);
    await worker.loadLanguage(lang);
    await worker.initialize(lang);
    const { data: { text } } = await worker.recognize(file, {}, {
      logger: m => {
        if (m.status === 'recognizing text')
          showProgress(15 + m.progress * 80, `Scanning: ${Math.round(m.progress * 100)}%`);
      }
    });
    await worker.terminate();
    showProgress(100, 'Done!');
    return text;
  }

  // ‚îÄ‚îÄ Copy (hidden) ‚îÄ‚îÄ
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(extractedText).then(() => {
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy', 2000);
    });
  };

  // ‚îÄ‚îÄ Read Aloud ‚îÄ‚îÄ
  readBtn.onclick = function() {
    if (!extractedText || extractedText.length < 5) return;
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(extractedText);

    // Auto-pick voice matching detected language
    const voice = pickVoice(detectedLang);
    if (voice) {
      utterance.voice = voice;
      utterance.lang  = voice.lang;
    }

    utterance.rate   = parseFloat(rateSlider.value);
    utterance.pitch  = parseFloat(pitchSlider.value);
    utterance.volume = 1.0;

    utterance.onstart  = () => { setStatus('üé§ Reading aloud‚Ä¶ <span class="reading-pulse">‚óè</span>', 'success'); readBtn.disabled = true; };
    utterance.onend    = () => { setStatus('‚úÖ Finished reading!', 'success'); readBtn.disabled = false; };
    utterance.onerror  = e  => { setStatus(`‚ùå Speech error: ${e.error}`, 'error'); readBtn.disabled = false; };
    utterance.onpause  = () => setStatus('‚è∏ Paused', 'warning');
    utterance.onresume = () => setStatus('üé§ Resumed reading‚Ä¶', 'success');

    window.speechSynthesis.speak(utterance);
  };

  // ‚îÄ‚îÄ Stop ‚îÄ‚îÄ
  stopBtn.onclick = function() {
    window.speechSynthesis.cancel();
    setStatus('‚èπ Stopped.', 'info');
    readBtn.disabled = extractedText.length < 5;
  };
</script>
</body>
</html>
